#!/usr/bin/env python

"""
This file offers services to interact with the custom library to move
sawyer to different states for the grabbing and throwing sequence
"""

# TODO: get default parameters from yaml file.

from __future__ import division
import numpy as np
import rospy

from the_mighty_sawyer import MoveArm

from std_srvs.srv import Empty, EmptyResponse, SetBool, SetBoolResponse
from geometry_msgs.msg import Pose

class ServClient(object):

    def __init__(self):

        self.sawyer = MoveArm()

        rospy.Service('start_up', Empty, self.start_up_callback)
        rospy.Service('go_to_home_pos', Empty, self.home_pos_callback)
        rospy.Service('overhand_throw', Empty, self.overhand_callback)
        rospy.Service('actuate_gripper', SetBool, self.actuate_gripper_callback)
        rospy.Service('make_adjustments', Empty, self.make_adjustments_callback)

    def start_up_callback(self, _ignore):
        """
        Callback for the start up service.
            1) Enables the robot.
            2) Calibrates the gripper

        This should be called first before trying to interact with the robot
        """
        self.sawyer.initializaton()

        return EmptyResponse()

    def home_pos_callback(self, _ignore):
        """
        Callback for the home position service

        Send the robot to the preconfigured home position.
        """
        self.sawyer.go_to_home_pos()

        return EmptyResponse()

    def overhand_callback(self, _ignore):
        """
        Callback for the overhand throw service
            1) positions the arm in a ready position
            2) Executes the throwing motion
        """
        self.sawyer.do_over_hand_toss()

        return EmptyResponse()

    def make_adjustments_callback(self, _ignore):
        """
        Callback for the make adjustments service
        """
        #
        # # Set first targeting angle
        # default_board_pose = Pose()
        #
        # default_board_pose.position.x = 16
        # default_board_pose.position.y = 84
        #
        # board_pose = Pose()
        #
        # board_pose.position.x = 32
        # board_pose.position.y = 60
        #
        # default_heading = np.arctan2(default_board_pose.position.y, default_board_pose.position.x)
        # target_heading = np.arctan2(board_pose.position.y, board_pose.position.x)
        #
        # dtheta_target = default_heading - target_heading
        #
        # default_range = ((default_board_pose.position.x)**2 + (default_board_pose.position.y)**2)**.5
        # target_range = ((board_pose.position.x)**2 + (board_pose.position.y)**2)**.5
        #
        # drange_target = (default_range - target_range) / (2*default_range)
        #
        # # y_diff_board = board_pose.position.y - default_board_pose.position.y
        # # x_diff_board = board_pose.position.x - default_board_pose.position.x
        # #
        # # print y_diff_board, x_diff_board
        # #
        # # theta_target = np.arctan2(y_diff_board, x_diff_board)
        #
        # bag_pose = Pose()
        #
        # bag_pose.position.x = 28
        # bag_pose.position.y = 63
        #
        # bag_heading = np.arctan2(bag_pose.position.y, bag_pose.position.x)
        #
        # dtheta_adjust =  bag_heading - target_heading
        #
        # # x_diff_throw = bag_pose.position.x - board_pose.position.x
        # # y_diff_throw = bag_pose.position.y - board_pose.position.y
        # #
        # # distance_from_target = ((x_diff_throw)**2 + (y_diff_throw)**2)**.5
        # # angle_from_target = np.arctan2(y_diff_throw, x_diff_throw)
        # #
        # #
        # # # Check if throw was
        # # if distance_from_target > 5 and angle_from_target < np.pi/2 and angle_from_target > -np.pi/2:
        # #     pass


        self.sawyer.overhand_throw_speed -= .125 # drange_target
        # self.sawyer.overhand_target_angle += dtheta_target + dtheta_adjust
        self.sawyer.overhand_release_angle = -1.4
        # rospy.loginfo(board_pose)
        # rospy.loginfo(dtheta_target)
        # rospy.loginfo(dtheta_adjust)
        rospy.loginfo(self.sawyer.overhand_target_angle)
        rospy.loginfo(self.sawyer.overhand_throw_speed)
        rospy.loginfo(self.sawyer.overhand_release_angle)

        return EmptyResponse()

    def actuate_gripper_callback(self, data):
        """
        Callback for the gripper service

        INPUTS:
            data (SetBool): 1 to open grippers, 0 to close grippers
        """
        self.sawyer.actuate_gripper(data)

        return SetBoolResponse(success=True,message="")

def main():

    rospy.init_node('sawyer_movement_server')

    ServClient()

    rospy.loginfo("Movement Server Ready!")

    rospy.spin()

if __name__ == '__main__':
    try:
        main()
    except rospy.ROSInterruptException:
        pass
